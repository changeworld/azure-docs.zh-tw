---
title: 讀取複本-適用於 PostgreSQL 的 Azure 資料庫-單一伺服器
description: 本文說明適用於 PostgreSQL 的 Azure 資料庫單一伺服器中的讀取複本功能。
author: sr-msft
ms.author: srranga
ms.service: postgresql
ms.topic: conceptual
ms.date: 11/05/2020
ms.openlocfilehash: 8fabf8169270c3162604b6535a6cf2fb07cd9a9d
ms.sourcegitcommit: 7cc10b9c3c12c97a2903d01293e42e442f8ac751
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 11/06/2020
ms.locfileid: "93422139"
---
# <a name="read-replicas-in-azure-database-for-postgresql---single-server"></a>讀取適用於 PostgreSQL 的 Azure 資料庫中的複本-單一伺服器

讀取複本功能可讓您將資料從適用於 PostgreSQL 的 Azure 資料庫伺服器複寫到唯讀伺服器。 複本會使用於 postgresql 引擎原生實體複寫技術 **以非同步方式** 更新。 您可以從主伺服器複寫到最多五個複本。

複本是新伺服器，管理方式類似於一般適用於 PostgreSQL 的 Azure 資料庫伺服器。 針對每個讀取複本，系統每月會針對在虛擬核心中所佈建的計算量，以及在儲存體中所佈建的容量 (以 GB 為單位) 向您收費。

了解如何[建立及管理複本](howto-read-replicas-portal.md)。

## <a name="when-to-use-a-read-replica"></a>何時應該使用讀取複本
讀取複本功能可針對需大量讀取的工作負載，協助改善效能及調整能力。 讀取工作負載可隔離到複本，而寫入工作負載可以導向至主要工作負載。 讀取複本也可以部署在不同的區域，而且可以在發生嚴重損壞修復時升級為讀取/寫入伺服器。

常見的案例是讓 BI 與分析工作負載使用讀取複本做為報告的資料來源。

由於複本是唯讀的，因此不會直接降低主要複本的寫入容量負擔。

### <a name="considerations"></a>考量
這項功能適用于延遲是可接受的，且適用于卸載查詢的情況。 它並不適用于預期複本資料為最新狀態的同步複寫案例。 主要和複本之間會有可測量的延遲。 這可以是幾分鐘甚至幾小時的時間，視工作負載和主資料庫和複本之間的延遲而定。 複本上的資料最終會與主資料庫上的資料一致。 請針對可接受此延遲的工作負載使用此功能。 

> [!NOTE]
> 針對大部分的工作負載，讀取複本會從主要複本提供近乎即時的更新。 不過，隨著持續性繁重的大量寫入主要工作負載，複寫延遲可能會持續成長，而且可能永遠無法趕上主要工作負載。 這也可能會增加主資料庫的儲存體使用量，因為 WAL 檔案在複本收到時，不會被刪除。 如果發生這種情況，在需要大量寫入的工作負載完成後，刪除並重新建立讀取複本的選項，就是將複本帶回較延時間的良好狀態的選項。
> 非同步讀取複本不適合這類大量寫入工作負載。 評估應用程式的讀取複本時，請在複本上監視延遲，以在其尖峰和非尖峰時間存取整個應用程式的工作負載週期，以在工作負載週期的各個點存取可能的延遲和預期的 RTO/RPO。
> 
## <a name="cross-region-replication"></a>跨區域複寫
您可以在主伺服器的不同區域中建立讀取複本。 跨區域複寫有助於災害復原規劃或讓資料更接近使用者之類的案例。

>[!NOTE]
> 基本層伺服器僅支援相同區域的複寫。

您可以在任何 [適用於 PostgreSQL 的 Azure 資料庫區域](https://azure.microsoft.com/global-infrastructure/services/?products=postgresql)中具有主伺服器。 主伺服器的配對區域或通用複本區域中可以有複本。 下圖顯示根據您的主要區域可使用的複本區域。

[:::image type="content" source="media/concepts-read-replica/read-replica-regions.png" alt-text="讀取複本區域":::](media/concepts-read-replica/read-replica-regions.png#lightbox)

### <a name="universal-replica-regions"></a>全球的複本區域
您一律可以在下列任何區域中建立讀取複本，而不論您的主伺服器所在位置為何。 這些是通用複本區域：

澳大利亞東部、澳大利亞東南部、巴西南部、加拿大中部、加拿大東部、美國中部、東亞、美國東部、美國東部2、日本東部、日本西部、韓國中部、南韓南部、美國中北部、歐洲北部、美國中南部、東南亞、英國南部、英國西部、西歐、美國西部、美國西部2、美國中西部。

### <a name="paired-regions"></a>配對的區域
除了通用複本區域，您可以在主伺服器的 Azure 配對區域中建立讀取複本。 如果您不知道所在區域的配對，則可以從 [Azure 配對區域](../best-practices-availability-paired-regions.md)一文深入了解。

如果您使用跨區域複本來規劃災害復原，建議您在配對區域中建立複本，而不要在其他區域之一建立。 配對區域可避免同時更新，並排定實體隔離和資料落地的優先順序。  

需要考慮的限制如下： 

* 區域可用性：法國中部、阿拉伯聯合大公國北部和德國中部都有提供適用於 PostgreSQL 的 Azure 資料庫。 不過，卻沒有提供其配對區域。
    
* 單向配對：某些 Azure 區域只會單向配對。 這些區域包括印度西部、巴西南部。 
   這表示印度西部的主伺服器可以在印度南部中建立複本。 不過，印度南部中的主伺服器無法在印度西部建立複本。 其原因是印度西部的次要區域是印度南部，但印度南部的次要區域卻不是印度西部。


## <a name="create-a-replica"></a>建立複本
當您開始建立複本的工作流程時，系統會建立空白的「適用於 PostgreSQL 的 Azure 資料庫」伺服器。 新伺服器會填入主伺服器上的資料。 建立時間取決於主資料庫上的資料量和自從上一周完整備份之後的時間。 時間的範圍可能介於數分鐘到數小時。

每個複本都會啟用儲存體[自動成長](concepts-pricing-tiers.md#storage-auto-grow)。 自動成長功能可讓複本與複寫的資料保持同步，並防止因儲存體錯誤而導致的複寫中斷。

讀取複本功能會使用 PostgreSQL 的實體複寫，而非邏輯複寫。 使用複寫位置的串流複寫是預設作業模式。 必要時，系統會使用記錄傳送來跟上進度。

了解如何[在 Azure 入口網站中建立讀取複本](howto-read-replicas-portal.md)。

## <a name="connect-to-a-replica"></a>連線到複本
當您建立複本時，它不會繼承主伺服器的防火牆規則或 VNet 服務端點。 您必須個別針對複本設定這些規則。

複本會從主伺服器繼承系統管理員帳戶。 主伺服器上的所有使用者帳戶都會複寫到讀取複本。 您只能使用主伺服器上可用的使用者帳戶來連接到讀取複本。

您可以使用複本的主機名稱和有效的使用者帳戶來連線到該複本，如同連線到一般適用於 PostgreSQL 的 Azure 資料庫伺服器一樣。 對於名為「 **我的複本** 」和「系統管理員使用者名稱 **myadmin** 」的伺服器，您可以使用 psql 連接到該複本：

```bash
psql -h myreplica.postgres.database.azure.com -U myadmin@myreplica -d postgres
```

在出現提示時，請輸入使用者帳戶的密碼。

## <a name="monitor-replication"></a>監視複寫
適用於 PostgreSQL 的 Azure 資料庫提供兩個計量來監視複寫。 這兩個計量是複本和 **複本延遲****之間的最大延隔** 時間。 若要瞭解如何查看這些計量，請參閱「 [讀取複本操作說明](howto-read-replicas-portal.md)」一文中的「 **監視複本** 」一節。

[ **複本之間的最大延隔** 時間] 計量會顯示主要與最延遲複本之間的延遲（以位元組為單位）。 此計量僅適用于主伺服器，而且只有當至少有一個讀取複本連接至主要複本，而且主要是串流複寫模式時，才可使用此度量。 當複本正在使用「檔案傳送」複寫模式中的主資料庫封存記錄來趕上主要複本時，延遲資訊不會顯示詳細資料。

[ **複本延隔** 時間] 計量會顯示上次重新執行的交易之後的時間。 如果您的主伺服器上沒有發生交易，計量會反映此時間延隔時間。 此計量僅適用于複本伺服器，且可供使用。 複本延隔時間是從 `pg_stat_wal_receiver` 視圖中計算：

```SQL
SELECT EXTRACT (EPOCH FROM now() - pg_last_xact_replay_timestamp());
```

請設定警示，以在複本延隔時間接近您工作負載無法接受的值時通知您。 

如需其他深入解析，請直接查詢主伺服器以取得所有複本的複寫延遲（以位元組為單位）。

> [!NOTE]
> 如果主伺服器或讀取複本重新開機，則重新開機和趕上所需的時間會反映在複本延隔標準中。

## <a name="stop-replication--promote-replica"></a>停止複寫/升階複本
您可以隨時停止主要複本與複本之間的複寫。 停止動作會導致複本重新開機，並將複本升級為獨立的獨立讀寫伺服器。 獨立伺服器中的資料是複製停止時，複本伺服器上可用的資料。 在主要複本上的任何後續更新都不會傳播至複本。 不過，複本伺服器可能會有尚未套用的累積記錄。 在重新開機過程中，複本會在接受用戶端連接之前套用所有暫止的記錄。  

### <a name="considerations"></a>考量
- 停止讀取複本上的複寫之前，請檢查複寫延遲，以確定複本具有您所需的所有資料。 
- 由於讀取複本必須套用所有擱置中的記錄檔，才能將它設為獨立伺服器，因此在停止複寫時，RTO 可能會比寫入繁重的工作負載更高，因為複本可能會有明顯的延遲。 規劃升級複本時請留意這一點。
- 升級後的複本伺服器無法再次變成複本。
- 如果您將複本升級為主伺服器，則無法將複寫建立回舊的主伺服器。 如果您想要回到舊的主要區域，您可以使用新名稱來建立新的複本伺服器 (或) 刪除舊的主要複本，並使用舊的主要名稱建立複本。
- 如果您有多個讀取複本，而且如果您將其中一個複本升級為主伺服器，其他複本伺服器仍會連接到舊的主伺服器。 您可能必須從新的升級伺服器重新建立複本。

當您停止複寫時，複本會失去其先前的主要複本和其他複本的所有連結。

了解如何[停止複寫至複本](howto-read-replicas-portal.md)。

## <a name="failover-to-replica"></a>容錯移轉至複本

當主伺服器失敗時，它 **不** 會自動容錯移轉到讀取複本。 

由於複寫是非同步，因此主要和複本之間可能會有相當長的延遲。 延隔量會受到一些因素的影響，例如在主伺服器上執行的工作負載類型，以及主要和複本伺服器之間的延遲。 在具有名義寫入工作負載的一般案例中，複本延遲需要幾秒鐘到幾分鐘的時間。 不過，在主要執行大量寫入工作負載的情況下，如果複本的速度不夠快，延遲可能會更高。 您可以使用計量 *複本延遲* 來追蹤每個複本的複寫延遲。 此計量會顯示自上次在複本上重新執行交易以來的時間。 建議您在一段時間內觀察複本延遲，以找出平均延遲。 您可以設定複本延遲的警示，如此一來，如果超出預期的範圍，系統就會通知您採取動作。

> [!Tip]
> 如果您容錯移轉至複本，從主要複本取消複本時的延遲將會指出遺失的資料量。

一旦您決定要容錯移轉至複本， 

1. 停止複寫至複本<br/>
   您必須執行此步驟，才能讓複本伺服器成為獨立伺服器，而且可以接受寫入。 在此過程中，複本伺服器將會重新開機，並從主要複本 delinked。 當您起始停止複寫後，後端進程通常需要幾分鐘的時間來套用任何尚未套用的剩餘記錄，並將資料庫開啟為可讀寫的伺服器。 請參閱本文的「 [停止](#stop-replication--promote-replica) 複寫」一節，以瞭解此動作的含意。
    
2. 將您的應用程式指向 (之前的) 複本<br/>
   每一部伺服器都有唯一的連接字串。 更新您的應用程式連接字串，使其指向 (之前的) 複本，而不是主要複本。
    
一旦您的應用程式成功處理讀取和寫入，您就已完成容錯移轉。 當您偵測到問題並完成上述步驟1和2時，您的應用程式所經歷的停機時間將會取決於您的情況。

### <a name="disaster-recovery"></a>災害復原

當發生重大的災難事件（例如可用性區域層級或區域性失敗）時，您可以藉由升級讀取複本來執行嚴重損壞修復作業。 您可以從 UI 入口網站流覽至讀取複本伺服器。 然後按一下 [複寫] 索引標籤，您可以停止複本將它升階為獨立的伺服器。 或者，您可以使用 [Azure CLI](/cli/azure/postgres/server/replica#az_postgres_server_replica_stop) 來停止及升級複本伺服器。

## <a name="considerations"></a>考量

本節將摘要說明有關讀取複本功能的考量。

### <a name="prerequisites"></a>必要條件
讀取複本和 [邏輯解碼](concepts-logical.md) 都取決於 Postgres 的預先寫入記錄 (WAL) 取得資訊。 這兩個功能需要來自 Postgres 的不同記錄層級。 邏輯解碼需要比讀取複本更高層級的記錄。

若要設定正確的記錄層級，請使用 Azure 複寫支援參數。 Azure 複寫支援有三個設定選項：

* **Off** -將最少的資訊放在 WAL 中。 這項設定無法在大部分的適用於 PostgreSQL 的 Azure 資料庫伺服器上使用。  
* **複本** -更 **詳細的資訊。** 這是 [讀取複本](concepts-read-replicas.md) 正常運作所需的最小記錄層級。 這項設定在大部分伺服器上是預設值。
* **邏輯** 更詳細的資訊比 **複本** 更詳細。 這是要讓邏輯解碼正常運作的最小記錄層級。 讀取複本也可在此設定中運作。


### <a name="new-replicas"></a>新複本
讀取複本會建立為最新適用於 PostgreSQL 的 Azure 資料庫伺服器。 現有伺服器無法設定為複本。 您無法為另一個讀取複本建立複本。

### <a name="replica-configuration"></a>複本設定
使用與主資料庫相同的計算和儲存體設定來建立複本。 建立複本之後，您可以變更數個設定，包括儲存體和備份保留期限。

建立或之後建立複本時，防火牆規則、虛擬網路規則和參數設定都不會從主伺服器繼承至複本。

### <a name="scaling"></a>調整大小
調整虛擬核心或一般目的與記憶體優化：
* 于 postgresql 需要 `max_connections` 次要伺服器上的設定 [大於或等於主伺服器上的設定](https://www.postgresql.org/docs/current/hot-standby.html)，否則次要伺服器將不會啟動。
* 在適用於 PostgreSQL 的 Azure 資料庫中，每個伺服器允許的連線數上限會固定到計算 sku，因為連接會佔用記憶體。 您可以深入瞭解 [max_connections 與計算 sku 之間的對應](concepts-limits.md)。
* 相應 **增加** ：先擴大複本的計算，然後擴大主要複本。 此順序可防止錯誤違反 `max_connections` 需求。
* 相應 **減少** ：先縮小主要的計算範圍，然後縮小複本的範圍。 如果您嘗試調整複本的範圍低於主要複本，將會發生錯誤，因為這違反了 `max_connections` 需求。

調整儲存體：
* 所有複本都會啟用儲存體自動成長，以防止來自儲存體完整複本的複寫問題。 您無法停用此設定。
* 您也可以手動擴大儲存體，就像在任何其他伺服器上所做的一樣。


### <a name="basic-tier"></a>基本層
基本層伺服器僅支援相同區域的複寫。

### <a name="max_prepared_transactions"></a>max_prepared_transactions
[于 postgresql 要求](https://www.postgresql.org/docs/current/runtime-config-resource.html#GUC-MAX-PREPARED-TRANSACTIONS) `max_prepared_transactions` 讀取複本上的參數值必須大於或等於主要值，否則複本將不會啟動。 如果您想要 `max_prepared_transactions` 在主要複本上變更，請先在複本上進行變更。

### <a name="stopped-replicas"></a>已停止的複本
如果您停止主伺服器和讀取複本之間的複寫，複本將會重新開機以套用變更。 停止的複本會變成支接受讀取和寫入的獨立伺服器。 獨立伺服器無法再次設定為複本。

### <a name="deleted-primary-and-standalone-servers"></a>已刪除主要和獨立伺服器
刪除主伺服器時，其所有讀取複本都會變成獨立伺服器。 這些複本將會重新啟動以反映此變更。

## <a name="next-steps"></a>後續步驟
* 了解如何[在 Azure 入口網站中建立及管理讀取複本](howto-read-replicas-portal.md)。
* 瞭解如何 [在 Azure CLI 和 REST API 中建立及管理讀取複本](howto-read-replicas-cli.md)。